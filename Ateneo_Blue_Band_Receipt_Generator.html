<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ateneo Blue Band - Receipt Generator</title>
<style>
  :root { --brand:#9F2C2C; --muted:#D394A6; --dark:#0F0F0F; }
  body { font-family:"Times New Roman", Georgia, serif; margin:0; background:#E5E5E5; color:#0F0F0F; }
  .wrap { display:flex; gap:20px; padding:18px; box-sizing:border-box; align-items:flex-start; }
  .ui { width:360px; background:#F7C7D3; border-radius:8px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.08); height:calc(100vh - 40px); overflow:auto; box-sizing:border-box; }
  .ui h2 { margin:0 0 10px 0; color:var(--brand); font-size:18px; }
  label { display:block; margin-top:10px; font-size:13px; color:var(--muted); }
  input[type="text"], input[type="date"], input[type="number"], select {
    width:100%; padding:8px 10px; margin-top:6px; box-sizing:border-box;
    border:1px solid #D394A6; border-radius:4px; font-size:14px;
  }
  .items { margin-top:12px; }
  .item-row { display:flex; gap:6px; margin-top:8px; align-items:center; }
  .item-row input { font-size:13px; }
  .item-row .desc { flex:1; }
  .item-row .qty { width:56px; }
  .item-row .price { width:90px; }
  .item-row .amount { width:95px; background:#F7C7D3; padding:7px; border-radius:4px; text-align:right; }
  .buttons { margin-top:12px; display:flex; gap:8px; }
  button { cursor:pointer; border:0; padding:10px 12px; border-radius:6px; font-weight:600; }
  .btn-add { background:transparent; border:1px dashed var(--brand); }
  .btn-done { background:var(--brand); color:#fff; flex:1; }
  .btn-print { background:#9F2C2C; color:#fff; flex:1; }
  #btn-download-json { background:#9F2C2C; width:100%; color:#fff; margin-top:10px; border:none; border-radius:6px; padding:10px; font-weight:600; cursor:pointer; }
  #btn-download-csv { background:#D64545; width:100%; color:#fff; margin-top:10px; border:none; border-radius:6px; padding:10px; font-weight:600; cursor:pointer; }
  #download-status { font-size:12px; color:#555; margin-top:6px; }
  .small { font-size:12px; color:var(--muted); margin-top:8px; }
  .preview-wrap { flex:1; display:flex; justify-content:center; align-items:flex-start; padding-bottom:40px; box-sizing:border-box; }
  .receipt { width:794px; background:#fff; box-shadow:0 4px 20px rgba(0,0,0,.08); padding:36px 46px; box-sizing:border-box; position:relative; color:#9F2C2C; }
  .header { display:flex; gap:12px; align-items:center; }
  .seal { width:120px; height:auto; flex-shrink:0; }
  .company { flex:1; display:flex; flex-direction:column; gap:4px; }
  .company h1 { margin:0; font-size:20px; letter-spacing:1px; color:var(--brand); }
  .company p { margin:0; font-size:12px; color:#9F2C2C; }
  .meta { border:1px solid #D394A6; padding:8px; width:260px; font-size:12px; color:#9F2C2C; border-radius:3px; }
  .meta div { display:flex; justify-content:space-between; }
  table.items { width:100%; border-collapse:collapse; margin-top:18px; font-size:13px; }
  table.items th { background:var(--brand); color:#fff; padding:10px; text-align:left; }
  table.items td { padding:10px; border:1px solid #e6eefc; vertical-align:top; }
  table.items td.center { text-align:center; }
  table.totals { width:95%; margin-left:auto; margin-top:8px; font-size:13px; border-collapse:collapse; }
  table.totals td { padding:6px; border:none; }
  .align-amount {text-align: right; padding-right: 46px; position: relative; right: 0;}
  .note { position:absolute; right:46px; bottom:78px; width:260px; font-size:15px; color:#9F2C2C; text-align:left; border-left:3px solid #b96767; padding-left:8px; }
  .validated { margin-top:18px; font-size:13px; color:#9F2C2C; }
  .validated strong { display:block; font-size:13px; }
  .write-line { border-bottom:1px solid #9F2C2C; display:inline-block; min-width:160px; padding-bottom:3px;  box-shadow: none; }
  .barcode-note { font-size:11px; color:#9F2C2C; text-align:center; margin-top:4px; }

  /* mobile-toggle button (hidden on desktop) */
  .mobile-toggle { display:none; margin-top:12px; width:100%; padding:10px; border-radius:6px; background:var(--dark); color:#fff; border:none; font-weight:700; cursor:pointer; }

  /* responsive: mobile layout */
  @media (max-width: 767px) {
    .wrap { display:block; padding:12px; }
    .ui { width:100%; height:auto; max-height:none; }
    .preview-wrap { display:none; } /* hide preview by default on mobile */
    .mobile-toggle { display:block; } /* show toggle on mobile only */
    .receipt { width:100%; box-shadow:none; padding:18px; }
    table.items, table.totals { font-size:12px; display:block; overflow:auto; width:100%; }
    .write-line { min-width:120px; }
  }

  /* === PRINT FIX: lock to one A4 page, no extra blanks === */
  @media print {
    body {
      background: #fff;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .wrap { padding: 0; display: block; }
    .ui { display: none; }
    .preview-wrap { display: block; padding: 0; }
    .receipt { box-shadow: none; margin: 0 auto; width: 210mm; height: 297mm; padding: 15mm; page-break-after: avoid; page-break-before: avoid; page-break-inside: avoid; overflow: hidden; }
    @page { size: A4; margin: 10mm; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="ui" id="ui">
    <h2>Receipt Encoder</h2>

    <label>Name</label>
    <input id="input-name" type="text" placeholder="e.g. Juan Dela Cruz">

    <label>Grade and Section</label>
    <input id="input-grade" type="text" placeholder="e.g. 11-Hurtado">

    <label>Email</label>
    <input id="input-email" type="text" placeholder="student@addu.edu.ph">

    <label>Payment Type</label>
    <select id="input-payment">
      <option>Cash</option><option>GCash</option><option>Bank Transfer</option>
    </select>

    <label>Invoice No.</label>
    <div style="display:flex; gap:8px;">
      <input id="input-invoice" type="text" placeholder="e.g. INV-2025-001" />
      <button id="btn-gen-invoice" style="flex:0 0 160px; background:var(--dark); color:#fff; border-radius:6px;">Generate Invoice No.</button>
    </div>

    <label>Date of Recording</label>
    <input id="input-date" type="date">

    <div class="items">
      <label>Items (Description ‚Ä¢ Qty ‚Ä¢ Price)</label>
      <div id="items-container">
        <div class="item-row">
          <input class="desc" placeholder="Description">
          <input class="qty" type="number" min="0" value="1">
          <input class="price" type="number" min="0" step="0.01" value="0.00">
          <div class="amount">‚Ç±0.00</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn-add" id="add-item">+ Add Item</button>
      </div>
    </div>

    <div class="small">Subtotal and total are calculated automatically.</div>

    <div class="buttons">
      <button class="btn-done" id="btn-done">Done (Fill Template)</button>
      <button class="btn-print" id="btn-print" style="display:none">Print Receipt</button>
    </div>

    <label style="margin-top:12px; font-size:13px; color:var(--muted)">Load existing valid_invoices.json (optional)</label>
    <input id="load-json" type="file" accept=".json" />

    <label style="margin-top:12px; font-size:13px; color:var(--muted)">Load existing payments CSV to merge (optional)</label>
    <input id="load-csv" type="file" accept=".csv" />

    <button id="btn-download-json">‚¨áÔ∏è Download Updated valid_invoices.json</button>
    <button id="btn-download-csv">‚¨áÔ∏è Download Payments Spreadsheet (CSV)</button>
    <div id="download-status">(Click after you finish printing receipts)</div>

    <!-- mobile-only toggle -->
    <button id="mobile-toggle-btn" class="mobile-toggle">üìÑ Show Receipt Preview</button>
  </div>

  <div class="preview-wrap" id="preview-wrap">
    <div class="receipt" id="receipt">
      <div class="header">
        <img class="seal" src="seal.png" alt="Ateneo Seal" />
        <div class="company">
          <h1>PAG-IBIG NAGA ALIMBUKAD</h1>
          <p>K.M.7 McArthur Highway, Talomo Davao City, Philippines, 8000</p>
        </div>
        <div style="display:flex;flex-direction:column; align-items:flex-end;">
          <div class="meta">
            <div><span>Invoice No.</span><strong id="r-invoice">____________</strong></div>
            <div style="margin-top:6px"><span>Date of Recording</span><strong id="r-date">____________</strong></div>
          </div>

          <svg id="barcode" class="knight" style="margin-top:10px"></svg>
          <div class="barcode-note">Verified by Pag-Ibing Naga Alimbukad Finance Officers</div>
        </div>
      </div>

      <table class="items" id="items-table">
        <thead>
          <tr><th>QTY</th><th>DESCRIPTION</th><th>PRICE</th><th>AMOUNT</th></tr>
        </thead>
        <tbody id="items-body"></tbody>
      </table>

      <table class="totals" style="width:100%; border-collapse:collapse; margin-top:8px; font-size:13px;">
        <tr><td></td><td style="text-align:right; padding-right:16px;">SUBTOTAL:</td><td id="r-subtotal" class="align-amount">‚Ç±0.00</td></tr>
        <tr><td></td><td style="text-align:right; padding-right:16px; font-weight:700">TOTAL:</td><td id="r-total" class="align-amount" style="font-weight:700;">‚Ç±0.00</td></tr>
      </table>
      
      <div class="note"><small>Note: Once an invoice is created, the purchase is final and non-refundable. Please review details before payment.</small></div>

      <div class="validated">
        <div><strong>Validated By:</strong></div>

        <!-- Brent -->
        <div style="margin-top:20px; position:relative; top:-25px;">
          <img id="sig-brent" src="sig_baguio.png" 
              style="height:100px; margin-bottom:1px; position:absolute; top:-25px;" 
              alt="sig_baguio"><br>
          <span id="name-brent" style="position:relative; top:0px;">Lead Gabrielle Buaya</span><br>
          <span id="role-brent">Finance Officer, Pag-Ibing Naga Alimbukad</span>
        </div>

        <!-- Lead -->
        <div style="position:relative; top:-100px;">
          <img id="sig-lead" src="sig_buaya.png"  style="height:120px; position:relative; top:50px; z-index:0;"alt="sig_buaya">
          <span id="name-lead" style="position:relative; top:0px; left:-87px; z-index:2;">Michael Johann Solis</span><br>
          <span id="role-lead">Assistant Finance Officer, Pag-Ibing Naga Alimbukad</span>
        </div>
      </div>

      <div style="position:absolute; left:46px; bottom:46px; font-size:13px; color:#9F2C2C;">
        <div>Payment Made By: <span class="write-line" id="r-name"></span></div>
        <div style="margin-top:6px">Grade and Section: <span class="write-line" id="r-grade"></span></div>
        <div style="margin-top:6px">Email: <span class="write-line" id="r-email"></span></div>
        <div style="margin-top:6px">Payment Type: <span class="write-line" id="r-payment"></span></div>
      </div>
    </div>
  </div>
</div>

<!-- JsBarcode -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<script>
/* -------------------------
   Helpers & state
   ------------------------- */
function currency(v){ return '‚Ç±' + Number(v||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

let sessionInvoices = [];      // invoice numbers added during this session
let sessionRecords = [];       // full record objects for CSV export
let loadedExistingData = null; // loaded valid_invoices.json
let loadedCsvRecords = [];     // records loaded from user CSV (array of record objects)

/* ========== Invoice generator =========== */
function todayYMD(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}${m}${day}`;
}
function getCounterForDate(dateStr){
  const key = `abb_invoice_counter_${dateStr}`;
  const raw = localStorage.getItem(key);
  return raw ? Number(raw) : 0;
}
function setCounterForDate(dateStr, n){
  const key = `abb_invoice_counter_${dateStr}`;
  localStorage.setItem(key, String(n));
}
function nextInvoiceNumber(){
  const d = todayYMD();
  let counter = getCounterForDate(d);
  counter = counter + 1;
  setCounterForDate(d, counter);
  const seq = String(counter).padStart(4,'0');
  return `INV-${d}-${seq}`;
}

/* Build item row */
function buildItemRow(desc='', qty=1, price=0){
  const tr = document.createElement('div');
  tr.className = 'item-row';
  tr.innerHTML = `<input class="desc" placeholder="Description" value="${desc}">
                  <input class="qty" type="number" min="0" value="${qty}">
                  <input class="price" type="number" min="0" step="0.01" value="${price}">
                  <div class="amount">${currency(qty*price)}</div>`;
  const qtyEl = tr.querySelector('.qty'), priceEl = tr.querySelector('.price'), amtEl = tr.querySelector('.amount');
  function recalc(){ amtEl.textContent = currency(Number(qtyEl.value||0) * Number(priceEl.value||0)); }
  qtyEl.addEventListener('input', recalc);
  priceEl.addEventListener('input', recalc);
  return tr;
}

/* init UI */
const itemsContainer = document.getElementById('items-container');
document.getElementById('add-item').addEventListener('click', ()=> itemsContainer.appendChild(buildItemRow()));

/* Load existing valid_invoices.json (optional) */
document.getElementById('load-json').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const rdr = new FileReader();
  rdr.onload = () => {
    try {
      const parsed = JSON.parse(rdr.result);
      if(Array.isArray(parsed.valid_invoices)) {
        loadedExistingData = parsed;
        document.getElementById('download-status').textContent = `Loaded ${parsed.valid_invoices.length} invoices from file`;
      } else {
        loadedExistingData = null;
        document.getElementById('download-status').textContent = `File loaded but has no "valid_invoices" array`;
      }
    } catch(err) {
      loadedExistingData = null;
      document.getElementById('download-status').textContent = `Invalid JSON file`;
    }
  };
  rdr.readAsText(f);
});

/* ========== Load existing CSV (optional, merges) ========== */
function parseCsvText(text){
  const rows = [];
  let cur = '';
  let row = [];
  let inQuotes = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    const nxt = text[i+1];
    if(ch === '"'){
      if(inQuotes && nxt === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && ch === ','){
      row.push(cur); cur=''; continue;
    }
    if(!inQuotes && (ch === '\n' || ch === '\r')){
      if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); row = []; cur=''; }
      while(text[i+1]==='\n' || text[i+1]==='\r') i++;
      continue;
    }
    cur += ch;
  }
  if(cur!=='' || row.length>0){ row.push(cur); rows.push(row); }
  return rows;
}

document.getElementById('load-csv').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const rdr = new FileReader();
  rdr.onload = () => {
    try {
      const text = rdr.result.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
      const rows = parseCsvText(text);
      if(rows.length < 1) throw new Error('No rows');
      const headers = rows[0].map(h => h.trim());
      const idx = {};
      headers.forEach((h,i)=> idx[h]=i);
      const parsed = [];
      for(let r=1;r<rows.length;r++){
        const row = rows[r];
        if(row.length === 0) continue;
        const invoice = (row[idx['Invoice No']]||row[0]||'').trim();
        if(!invoice) continue;
        const name = (row[idx['Name']]||'').trim();
        const grade = (row[idx['Grade & Section']]||'').trim();
        const email = (row[idx['Email']]||'').trim();
        const payment = (row[idx['Payment Type']]||'').trim();
        const date = (row[idx['Date']]||'').trim();
        const subtotal = parseFloat((row[idx['Subtotal']]||'0').trim())||0;
        const total = parseFloat((row[idx['Total']]||row[idx['Subtotal']]||'0').trim())||0;
        const itemsRaw = (row[idx['Items']]||'').trim();
        const created_at = (row[idx['Created At']]||new Date().toISOString()).trim();
        const items = itemsRaw ? itemsRaw.split(' || ').map(it=>{
          const parts = it.split('|');
          return { desc: parts[0]||'', qty: Number(parts[1]||0), price: Number(parts[2]||0) };
        }) : [];
        parsed.push({ invoice, name, grade, email, payment, date, items, subtotal, total, created_at });
      }
      parsed.forEach(pr=>{
        if(!loadedCsvRecords.find(x=>x.invoice === pr.invoice)) loadedCsvRecords.push(pr);
      });
      document.getElementById('download-status').textContent = `Loaded ${parsed.length} records from CSV (merged)`;
    } catch(err) {
      loadedCsvRecords = [];
      document.getElementById('download-status').textContent = `Invalid CSV file`;
    }
  };
  rdr.readAsText(f);
});

/* ======================================================
   Generate Invoice button (and auto-gen on done/print)
   ====================================================== */
document.getElementById('btn-gen-invoice').addEventListener('click', ()=>{
  const existing = document.getElementById('input-invoice').value.trim();
  if(existing && !confirm('Invoice field already has a value. Overwrite?')) return;
  const inv = nextInvoiceNumber();
  document.getElementById('input-invoice').value = inv;
});

/* ======================================================
   Fill receipt preview (Done button)
   ====================================================== */
document.getElementById('btn-done').addEventListener('click', function(){
  // auto-generate invoice if empty
  if(!document.getElementById('input-invoice').value.trim()){
    document.getElementById('input-invoice').value = nextInvoiceNumber();
  }

  const name = document.getElementById('input-name').value || '';
  const grade = document.getElementById('input-grade').value || '';
  const email = document.getElementById('input-email').value || '';
  const payment = document.getElementById('input-payment').value || '';
  const invoice = document.getElementById('input-invoice').value || '';
  const date = document.getElementById('input-date').value || '';

  // preview fields
  document.getElementById('r-name').textContent = name || '';
  document.getElementById('r-grade').textContent = grade || '';
  document.getElementById('r-email').textContent = email || '';
  document.getElementById('r-payment').textContent = payment || '';
  document.getElementById('r-invoice').textContent = invoice || '';
  document.getElementById('r-date').textContent = date || '';

  // barcode
  if(invoice) {
    try{
      JsBarcode("#barcode", invoice, { format:"CODE128", lineColor:"#9F2C2C", width:1.6, height:40, displayValue:true, fontSize:12 });
    }catch(e){
      document.getElementById('barcode').innerHTML = '';
    }
  } else {
    document.getElementById('barcode').innerHTML = '';
  }

  // items -> table body
  const rows = itemsContainer.querySelectorAll('.item-row');
  const body = document.getElementById('items-body');
  body.innerHTML = '';
  let subtotal = 0;
  rows.forEach(r=>{
    const desc = r.querySelector('.desc').value || '';
    const qty = Number(r.querySelector('.qty').value || 0);
    const price = Number(r.querySelector('.price').value || 0);
    const amt = qty * price;
    subtotal += amt;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class='center'>${qty}</td><td>${desc}</td><td style='text-align:right'>${currency(price)}</td><td style='text-align:right;font-weight:600'>${currency(amt)}</td>`;
    body.appendChild(tr);
  });

  document.getElementById('r-subtotal').textContent = currency(subtotal);
  document.getElementById('r-total').textContent = currency(subtotal);
  document.getElementById('btn-print').style.display = 'inline-block';
});

/* ======================================================
   Record current receipt (returns record object)
   ====================================================== */
function recordCurrentReceipt(){
  const invoice = document.getElementById('input-invoice').value.trim();
  if(!invoice) return null;

  const name = document.getElementById('input-name').value.trim();
  const grade = document.getElementById('input-grade').value.trim();
  const email = document.getElementById('input-email').value.trim();
  const payment = document.getElementById('input-payment').value.trim();
  const date = document.getElementById('input-date').value.trim();
  // items
  const rows = itemsContainer.querySelectorAll('.item-row');
  const items = [];
  let subtotal = 0;
  rows.forEach(r=>{
    const desc = r.querySelector('.desc').value || '';
    const qty = Number(r.querySelector('.qty').value || 0);
    const price = Number(r.querySelector('.price').value || 0);
    const amt = qty * price;
    subtotal += amt;
    items.push({desc, qty, price});
  });
  const record = {
    invoice,
    name,
    grade,
    email,
    payment,
    date,
    items,
    subtotal,
    total: subtotal,
    created_at: (new Date()).toISOString()
  };

  // add to sessionInvoices and sessionRecords if not duplicate
  if(!sessionInvoices.includes(invoice)) sessionInvoices.push(invoice);
  if(!sessionRecords.find(r => r.invoice === invoice)) sessionRecords.push(record);

  return record;
}

/* ======================================================
   CSV helpers
   ====================================================== */
function escapeCsvValue(v){
  if(v == null) return '';
  const s = String(v).replace(/"/g,'""');
  if(s.includes(',') || s.includes('"') || s.includes('\n')) return `"${s}"`;
  return s;
}
function serializeItemsForCsv(items){
  return items.map(it => `${it.desc}|${it.qty}|${it.price}`).join(' || ');
}

/* ======================================================
   Merge records: loadedCsvRecords + sessionRecords (no dup invoices)
   ====================================================== */
function mergedRecords(){
  const map = new Map();
  loadedCsvRecords.forEach(r => map.set(r.invoice, r));
  sessionRecords.forEach(r => map.set(r.invoice, r));
  return Array.from(map.values());
}

/* ======================================================
   Download CSV (manual or auto)
   ====================================================== */
function downloadCsvFile(records, filename){
  const headers = ['Invoice No','Name','Grade & Section','Email','Payment Type','Date','Subtotal','Total','Items','Created At'];
  const rows = [headers.map(escapeCsvValue).join(',')];
  records.forEach(rec=>{
    const itemsSerialized = serializeItemsForCsv(rec.items);
    const row = [
      rec.invoice,
      rec.name,
      rec.grade,
      rec.email,
      rec.payment,
      rec.date,
      rec.subtotal.toFixed(2),
      rec.total.toFixed(2),
      itemsSerialized,
      rec.created_at
    ].map(escapeCsvValue).join(',');
    rows.push(row);
  });
  const csvContent = rows.join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(link.href);
}

/* ======================================================
   Print button behavior: print, record, merge, auto-download CSV & JSON
   ====================================================== */
document.getElementById('btn-print').addEventListener('click', async ()=>{
  // ensure invoice exists
  if(!document.getElementById('input-invoice').value.trim()){
    document.getElementById('input-invoice').value = nextInvoiceNumber();
  }

  // Print preview will show the receipt even if preview hidden on mobile (print CSS forces it)
  window.print();

  const rec = recordCurrentReceipt();
  if(!rec) return;

  // Merge and auto-download CSV (merged with loadedCsvRecords)
  const merged = mergedRecords(); // combined records
  const csvFilename = `payments_${new Date().toISOString().split('T')[0]}.csv`;
  downloadCsvFile(merged, csvFilename);
  document.getElementById('download-status').textContent = `‚úÖ Auto-downloaded ${csvFilename} (${merged.length} rows)`;

  // Also handle valid_invoices.json merge & download
  if(loadedExistingData && Array.isArray(loadedExistingData.valid_invoices)) {
    const mergedInvoices = Array.from(new Set([ ...loadedExistingData.valid_invoices, ...sessionInvoices ]));
    saveJSON({ valid_invoices: mergedInvoices }, `valid_invoices_${new Date().toISOString().split('T')[0]}.json`);
    document.getElementById('download-status').textContent += ` ‚Ä¢ ‚úÖ Updated valid_invoices.json (${mergedInvoices.length})`;
    return;
  }

  try {
    const res = await fetch('valid_invoices.json');
    const data = await res.json();
    if(!Array.isArray(data.valid_invoices)) data.valid_invoices = [];
    sessionInvoices.forEach(inv => { if(!data.valid_invoices.includes(inv)) data.valid_invoices.push(inv); });
    saveJSON(data, `valid_invoices_${new Date().toISOString().split('T')[0]}.json`);
    document.getElementById('download-status').textContent += ` ‚Ä¢ ‚úÖ Updated valid_invoices.json (${data.valid_invoices.length})`;
  } catch(err) {
    // fallback
    saveJSON({ valid_invoices: sessionInvoices }, `valid_invoices_${new Date().toISOString().split('T')[0]}.json`);
    document.getElementById('download-status').textContent += ` ‚Ä¢ ‚úÖ Created valid_invoices.json (${sessionInvoices.length})`;
  }
});

/* ======================================================
   Manual CSV download button
   ====================================================== */
document.getElementById('btn-download-csv').addEventListener('click', ()=>{
  const merged = mergedRecords();
  const filename = `payments_${new Date().toISOString().split('T')[0]}.csv`;
  downloadCsvFile(merged, filename);
  document.getElementById('download-status').textContent = `‚úÖ Downloaded ${filename} (${merged.length} rows)`;
});

/* ======================================================
   Manual JSON download button
   ====================================================== */
document.getElementById('btn-download-json').addEventListener('click', async ()=>{
  if(loadedExistingData && Array.isArray(loadedExistingData.valid_invoices)) {
    const mergedInvoices = Array.from(new Set([ ...loadedExistingData.valid_invoices, ...sessionInvoices ]));
    saveJSON({ valid_invoices: mergedInvoices }, `valid_invoices_${new Date().toISOString().split('T')[0]}.json`);
    document.getElementById('download-status').textContent = `‚úÖ Downloaded merged valid_invoices.json (${mergedInvoices.length})`;
    return;
  }

  try {
    const res = await fetch('valid_invoices.json');
    const data = await res.json();
    if(!Array.isArray(data.valid_invoices)) data.valid_invoices = [];
    sessionInvoices.forEach(inv => { if(!data.valid_invoices.includes(inv)) data.valid_invoices.push(inv); });
    saveJSON(data, `valid_invoices_${new Date().toISOString().split('T')[0]}.json`);
    document.getElementById('download-status').textContent = `‚úÖ Downloaded merged valid_invoices.json (${data.valid_invoices.length})`;
  } catch(err) {
    saveJSON({ valid_invoices: sessionInvoices }, `valid_invoices_${new Date().toISOString().split('T')[0]}.json`);
    document.getElementById('download-status').textContent = `‚úÖ Downloaded session valid_invoices.json (${sessionInvoices.length})`;
  }
});

/* ======================================================
   Mobile preview toggle (no animation)
   ====================================================== */
const mobileToggleBtn = document.getElementById('mobile-toggle-btn');
const previewWrap = document.getElementById('preview-wrap');
mobileToggleBtn && mobileToggleBtn.addEventListener('click', ()=>{
  if(previewWrap.style.display === 'block' || previewWrap.style.display === '') {
    // hide it
    previewWrap.style.display = 'none';
    mobileToggleBtn.textContent = 'üìÑ Show Receipt Preview';
    // ensure on mobile the print still works (print CSS forces it)
  } else {
    previewWrap.style.display = 'block';
    mobileToggleBtn.textContent = 'üìÑ Hide Receipt Preview';
  }
});

/* ======================================================
   Utility: save JSON (download)
   ====================================================== */
function saveJSON(obj, filename = 'valid_invoices.json') {
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(link.href);
}
</script>
</body>
</html>